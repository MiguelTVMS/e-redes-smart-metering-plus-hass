#!/bin/bash
# Pre-commit hook for E-Redes Smart Metering Plus Home Assistant Integration
# This hook runs the same validations as GitHub Actions

set -e

echo "ğŸ” Running pre-commit validations..."
echo ""

# Check if we're in the right directory
if [ ! -f "custom_components/e_redes_smart_metering_plus/manifest.json" ]; then
    echo "âŒ Error: Not in the correct repository root"
    exit 1
fi

# Check if Python files are staged
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -z "$PYTHON_FILES" ]; then
    echo "â„¹ï¸  No Python files staged for commit, skipping linting checks"
    exit 0
fi

echo "ğŸ“ Staged Python files:"
echo "$PYTHON_FILES"
echo ""

# Check if dependencies are installed
if ! command -v black &> /dev/null || ! command -v isort &> /dev/null || ! command -v ruff &> /dev/null; then
    echo "âš ï¸  Warning: Linting tools not found. Installing dependencies..."
    pip install -q -r requirements_dev.txt
    echo ""
fi

# Flag to track if any checks fail
CHECKS_FAILED=0

# Run black
echo "ğŸ–¤ Running black..."
if ! black --check --diff custom_components/; then
    echo ""
    echo "âŒ Black formatting check failed!"
    echo "ğŸ’¡ Run 'black custom_components/' to fix formatting issues"
    CHECKS_FAILED=1
else
    echo "âœ… Black check passed"
fi
echo ""

# Run isort
echo "ğŸ“¦ Running isort..."
if ! isort --check-only --diff custom_components/; then
    echo ""
    echo "âŒ isort import sorting check failed!"
    echo "ğŸ’¡ Run 'isort custom_components/' to fix import ordering"
    CHECKS_FAILED=1
else
    echo "âœ… isort check passed"
fi
echo ""

# Run ruff
echo "ğŸ”§ Running ruff..."
if ! ruff check custom_components/; then
    echo ""
    echo "âŒ Ruff linting check failed!"
    echo "ğŸ’¡ Run 'ruff check --fix custom_components/' to auto-fix issues"
    CHECKS_FAILED=1
else
    echo "âœ… Ruff check passed"
fi
echo ""

# Run pytest if test files are staged
TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^tests/.*\.py$' || true)
if [ -n "$TEST_FILES" ] || [ -n "$PYTHON_FILES" ]; then
    echo "ğŸ§ª Running pytest..."
    if ! pytest tests/ -q --tb=short; then
        echo ""
        echo "âŒ Tests failed!"
        CHECKS_FAILED=1
    else
        echo "âœ… Tests passed"
    fi
    echo ""
fi

# Check results
if [ $CHECKS_FAILED -eq 1 ]; then
    echo ""
    echo "âŒ Pre-commit checks failed! Please fix the issues above before committing."
    echo ""
    echo "Quick fix commands:"
    echo "  black custom_components/"
    echo "  isort custom_components/"
    echo "  ruff check --fix custom_components/"
    echo ""
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
echo ""
exit 0
